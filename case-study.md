# Case-study оптимизации



## Проблема №1
Импорт данных на файле large.json занимает больше 10минут, нужно ускорить импорт, чтобы он проходил в пределах минуты.

- Метрика - время выполнения импорта 

## Подготовка
1. Логику импорта вынес в класс и написал тест

## Feedback-Loop
1. Профилирование
2. Изменение кода
3. Тесты
4. Постоение отчета

Время цикла: 10сек - 40сек

## Инструменты
- benchmark
- pg-hero

### Предварительный анализ
Время выполнения  на файле small: 11.822сек

### Находка №1
- ![before](docs/profiling/1.png)
- Убрал запись сервисов автобусов из цикла, добавил хэш buses_services = { bus_id: service_ids }
- Время выполнения на файле small: снизилось 11.822сек => 6.9сек 
- исправленная проблема перестала быть главной точкой роста

### Находка №2
- ![before](docs/profiling/2.png)
- Добавил составной индекс %i[model number]
- Время выполнения на файле small: не изменилось 6.9сек
- исправленная проблема перестала быть главной точкой роста

### Находка №3
- ![before](docs/profiling/3.png)
- Вынес создание сервисов вне цикла и вынес их в хэш { service.name => service.id }
- Время выполнения на файле small: снизилось 6.9сек => 4.415сек
- исправленная проблема перестала быть главной точкой роста

### Находка №4
- ![before](docs/profiling/4.png)
- Добавил составной индекс на поле number
- Время выполнения на файле small: не изменилось 4.415сек
- Время выполнения на файле medium: 31.257сек
- исправленная проблема перестала быть главной точкой роста

### Находка №5
- ![before](docs/profiling/5.png)
- Вынес города в хэш { city.name => city.id }
- Время выполнения на файле medium: не изменилось 31.257сек
- исправленная проблема перестала быть главной точкой роста

### Находка №6
- ![before](docs/profiling/6.png) большое кол-во ставок трипов
- Переписал на массовую вставку с использованием gem activerecord-import
- Время выполнения на файле medium: снизилось 31.257сек => 10.173сек
- исправленная проблема перестала быть главной точкой роста
